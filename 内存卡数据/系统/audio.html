<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <link rel="stylesheet" href="../system/CSS/fontawesome-free-6.5.2-web/css/all.min.css">
    <link rel="stylesheet" href="../system/css.css" />
    <title>音乐播放</title>
    <style>
        html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #audio-player {
            position: relative;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: 30%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-image: linear-gradient(to bottom right, #ff69b4, #87CEFA);
            border-radius: 5px;
            padding: 20px;
            border-radius: 10px;
            background-color: #f0f8ff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #audio-player h2 {
            margin: 0;
        }

        #current-song-title {
            text-align: left;
        }

        .player {
            width: 300px;
            margin: 0 auto;
            text-align: center;
            display: block;
        }

        button {
            margin: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .progress-barmusic {
            width: 60%;
            height: 30px;
            background-color: #ccc;
            overflow: hidden;
            position: relative;
            border-radius: 15px;
        }

        .progress-barmusic-filled {
            position: absolute;
            top: 0;
            left: 15;
            height: 100%;
            background-color: #87CEEB;
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        #audio-list::-webkit-scrollbar {
            display: none;
        }

        #audio-list {
            list-style-type: none;
            padding: 0;
            max-height: 20%;
            overflow-y: scroll;
            margin-bottom: 10px;
        }

        .audio-item {
            cursor: pointer;
            padding: 5px 5px 5px 25px;
            border-bottom: 1px solid #ccc;
            position: relative;
            padding-left: 20px;
            border-radius: 10px;
            margin-bottom: 5px;
            color: #333;
            border-color: #aaa;
        }

        .audio-item:hover {
            background-color: #f0f0f0;
            opacity: 0.8;
        }

        .audio-item:before {
            content: "\f001";
            font-family: 'FontAwesome';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            transition: color 0.3s ease;
        }

        .audio-item:hover:before {
            color: #007bff;
        }

        .active::before {
            content: '\f00c';
            font-family: 'FontAwesome';
            color: #007bff;
            margin-right: 5px;
        }

        .active {
            background-color: #ddd;
        }

        #audio-controls {
            position: fixed;
            bottom: 10%;
            left: 20%;
            width: 60%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-image: linear-gradient(to right, #ff69b4, #87CEFA);
            padding: 10px;
            box-sizing: border-box;
            z-index: 100;
            border-radius: 100px;
        }

        .control-button {
            margin: 0 5px;
            padding: 0;
            border: none;
            background-color: transparent;
            cursor: pointer;
            outline: none;
            font-size: 1.2em;
        }

        .play-pause i:before {
            content: "\f04b";
            font-size: 1.5em;
        }

        .play-pause.playing i:before {
            content: "\f04c";
        }

        .control-button i {
            color: #007bff;
            font-size: 1.2em;
        }

        .control-button:hover i {
            color: #0056b3;
        }

        #time-display {
            display: flex;
            justify-content: space-between;
            margin-left: 10px;
        }

        .active-loop:before {
            content: "\f01e";
        }

        .active-shuffle:before {
            content: "\f074";
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li>
                <a class="logo">
                    <img src="../config/logo.jpg" alt="" />
                    <span class="nav-item">哈哈233的网盘</span>
                </a>
            </li>
            <li>
                <a href="../system/wifi.html">
                    <i class="fa-sharp fa-solid fa-wifi"></i>
                    <span class="nav-item">网络配置</span>
                </a>
            </li>
            <li>
                <a href="../system/upload.html">
                    <i class="fa-sharp fa-solid fa-circle-up"></i>
                    <span class="nav-item">文件快传</span>
                </a>
            </li>
            <li class="current-page">
                <a href="../system/audio.html">
                    <i class="fa-sharp fa-solid fa-headphones"></i>
                    <span class="nav-item">音乐播放</span>
                </a>
            </li>
            <li>
                <a href="../system/webgame.html">
                    <i class="fa-sharp fa-solid fa-gamepad"></i>
                    <span class="nav-item">网页游戏</span>
                </a>
            </li>
            <li>
                <a href="../system/video.html">
                    <i class="fa-sharp fa-solid fa-film"></i>
                    <span class="nav-item">私人影院</span>
                </a>
            </li>
            <li>
                <a href="../system/clipboard.html">
                    <i class="fa-sharp fa-solid fa-clipboard"></i>
                    <span class="nav-item">剪切板</span>
                </a>
            </li>
            <li>
                <a href="../system/allFile.html">
                    <i class="fa-sharp fa-solid fa-folder"></i>
                    <span class="nav-item">文件总管理</span>
                </a>
            </li>
            <li>
                <a href="/wificonnect">
                    <i class="fa-sharp fa-solid fa-gears"></i>
                    <span class="nav-item">模式转换</span>
                </a>
            </li>
            <li>
                <a href="../system/set.html">
                    <i class="fa-sharp fa-solid fa-gear"></i>
                    <span class="nav-item">设置</span>
                </a>
            </li>
            <li>
                <a href="">
                    <i class="fa-sharp fa-solid fa-database"></i>
                    <span class="nav-item" id="currentMemory"></span>
                    <span class="nav-item" id="totalMemory"></span>
                </a>
                <div class="progress-bar" id="memory-progress">
                </div>
            </li>
        </ul>
    </nav>
    <div id="audio-player">
        <h2>
            <div id="current-song-title">当前歌曲:</div>
        </h2>
        <audio id="audioPlayer" src="" preload="auto"></audio>
        <ul id="audio-list"></ul>
    </div>
    <div id="audio-controls">
        <button onclick="prevTrack()" class="control-button">
            <i class="fas fa-step-backward"></i>
        </button>
        <button onclick="playPause()" class="control-button play-pause">
            <i class="fas fa-play"></i>
        </button>
        <button onclick="nextTrack()" class="control-button">
            <i class="fas fa-step-forward"></i>
        </button>
        <button onclick="togglePlaybackMode()" class="control-button playback-mode">
            <i class="fas fa-retweet"></i>
        </button>
        <div class="progress-barmusic">
            <div class="progress-barmusic-filled " id="progressFilled"></div>
        </div>
        <p id="time-display">
            <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
        </p>
    </div>
</body>

<script>
    let currentTrackIndex = 0;
    const audioPlayer = document.getElementById('audioPlayer');
    const audioListElement = document.getElementById('audio-list');
    let playlist = [];

    let isLooping = false;
    let isShuffling = false;
    let playbackModeIndex = 0;
    const playbackModes = ['normal', 'loop', 'shuffle'];

    function togglePlaybackMode() {
        playbackModeIndex = (playbackModeIndex + 1) % playbackModes.length;
        let mode = playbackModes[playbackModeIndex];

        isLooping = mode === 'loop';
        isShuffling = mode === 'shuffle';

        let iconClass = '';
        let iconName = '';

        if (isLooping) {
            iconClass = 'active-loop';
            iconName = 'fa-retweet';
        } else if (isShuffling) {
            iconClass = 'active-shuffle';
            iconName = 'fa-random';
        }

        let iconElement = document.querySelector('.playback-mode i');
        iconElement.classList.remove('active-loop', 'active-shuffle');
        if (iconName) {
            iconElement.className = `fas ${iconName} ${iconClass}`;
        } else {
            iconElement.className = 'fas fa-retweet';
        }
    }

    function listAudio() {
        fetch('/listaudio')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json(); // 假设返回的是一个包含音乐列表和存储信息的混合数组
            })
            .then(data => {
                const audioList = document.getElementById('audio-list');
                audioList.innerHTML = ''; // 清空现有列表
                playlist = data.musicList;
                // 直接使用musicData遍历，不再需要playlist变量的赋值
                data.musicList.forEach((track, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = track.filename;
                    listItem.dataset.index = index;
                    listItem.classList.add('audio-item');
                    listItem.addEventListener('click', () => {
                        currentTrackIndex = index;
                        loadAndPlayTrack(currentTrackIndex); // 确保loadAndPlayTrack函数已定义
                    });
                    audioList.appendChild(listItem);
                });

                // 单独处理存储信息
                calStorage(data.storageInfo); // 确保calStorage函数能正确处理存储信息对象
                adjustListHeightBasedOnLines(); // 调整列表高度
            })
            .catch(error => console.error('Error:', error));
    }

    function loadAndPlayTrack(index) {
        if (index < 0 || index >= playlist.length) {
            console.error('无效的索引:', index);
            return;
        }
        const track = playlist[index];
        if (track) {
            audioPlayer.src = track.filepath;

            audioPlayer.addEventListener('canplay', function () {
                this.play().catch(error => console.error('Play request was interrupted or failed:', error));
                this.removeEventListener('canplay', arguments.callee);

                if (!audioPlayer.paused) {
                    document.querySelector('.play-pause').classList.add('playing');
                }
            });

            setActiveTrack(currentTrackIndex);

            document.getElementById('current-song-title').textContent = `当前歌曲: ${track.filename}`;
        } else {
            console.error('Track not found at the given index.');
        }
    }

    function setActiveTrack(index) {
        const items = audioListElement.children;
        for (let i = 0; i < items.length; i++) {
            items[i].classList.toggle('active', i === index);
        }
    }

    function playPause() {
        if (audioPlayer.paused) {
            audioPlayer.play().catch(error => console.error('Play request was interrupted or failed:', error));
            document.querySelector('.play-pause').classList.add('playing');
        } else {
            audioPlayer.pause();
            document.querySelector('.play-pause').classList.remove('playing');
        }
    }

    function prevTrack() {
        if (currentTrackIndex > 0) {
            currentTrackIndex--;
        } else {
            currentTrackIndex = playlist.length - 1;
        }
        loadAndPlayTrack(currentTrackIndex);
    }

    function nextTrack() {
        if (isLooping && !isShuffling) {
            return;
        } else if (isShuffling) {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * playlist.length);
            } while (newIndex === currentTrackIndex);
            currentTrackIndex = newIndex;
        } else {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
        }
        loadAndPlayTrack(currentTrackIndex);
    }

    audioPlayer.addEventListener('timeupdate', function () {
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const progressBarFilled = document.getElementById('progressFilled');

        currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);

        if (audioPlayer.duration) {
            const progressPercentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBarFilled.style.width = `${progressPercentage}%`;
        }
    });

    function formatTime(seconds) {
        let minutes = Math.floor(seconds / 60);
        let secondsRemainder = Math.round(seconds % 60);
        return `${minutes < 10 ? '0' : ''}${minutes}:${secondsRemainder < 10 ? '0' : ''}${secondsRemainder}`;
    }

    audioPlayer.addEventListener('ended', function () {
        nextTrack();
    });
    audioPlayer.addEventListener('canplaythrough', function () {
        console.log('音频可以持续播放至结束，无需缓冲');
    });

    function adjustListHeightBasedOnLines(lines = 16) {
        const listItem = document.querySelector('.audio-item');
        if (listItem) {
            const lineHeight = listItem.offsetHeight;
            const desiredHeight = lineHeight * lines;
            document.getElementById('audio-list').style.maxHeight = `${desiredHeight}px`;
        } else {
            console.error('No list item found to calculate height.');
        }
    }
    function calStorage(data) {
        const currentMemoryStr = bytesToSize(data.totalstorage);
        const totalMemoryStr = bytesToSize(data.totalstorage - data.storage);

        document.getElementById('currentMemory').innerText = totalMemoryStr;
        document.getElementById('totalMemory').innerText = " / " + currentMemoryStr;

        let percentageUsed = (data.storage / data.totalstorage) * 100;
        percentageUsed = Math.min(percentageUsed, 100);
        const progressBar = document.getElementById('memory-progress');
        progressBar.style.background = `linear-gradient(to right, #007bff 0%, #f3f3 ${percentageUsed}%)`;
    }
    function bytesToSize(bytes) {
        var sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        if (bytes == 0) return '0 B';
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        var size = bytes / Math.pow(1024, i); // 不预先四舍五入，以便在最后统一处理小数位
        // 对于非“B”单位，始终保留两位小数
        if (sizes[i] !== 'B') {
            size = size.toFixed(2);
        }
        return size + ' ' + sizes[i];
    }

    window.onload = listAudio;
</script>

</html>