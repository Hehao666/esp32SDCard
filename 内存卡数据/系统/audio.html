<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8DwQMAAFAbQIOMhQIiIAwQAAAABJRU5ErkJggg==" />
    <link rel="stylesheet" href="../系统/CSS/style.css">
    <title>音乐播放</title>
    <style>
        html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #audio-player {
            position: relative;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: 30%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-image: linear-gradient(to bottom right, #ff69b4, #87CEFA);
            border-radius: 5px;
            padding: 20px;
            border-radius: 10px;
            background-color: #f0f8ff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            left: -10%;
        }

        #audio-player h2 {
            margin: 0;
        }

        #current-song-title {
            text-align: left;
        }

        .player {
            width: 300px;
            margin: 0 auto;
            text-align: center;
            display: block;
        }

        button {
            margin: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .progress-barmusic {
            width: 60%;
            height: 30px;
            background-color: #ccc;
            overflow: hidden;
            position: relative;
            border-radius: 15px;
        }

        .progress-barmusic-filled {
            position: absolute;
            top: 0;
            left: 15;
            height: 100%;
            background-color: #87CEEB;
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        #audio-list::-webkit-scrollbar {
            display: none;
        }

        #audio-list {
            list-style-type: none;
            padding: 0;
            max-height: 20%;
            overflow-y: scroll;
            margin-bottom: 10px;
        }

        .audio-item {
            cursor: pointer;
            padding: 5px 5px 5px 25px;
            border-bottom: 1px solid #ccc;
            position: relative;
            padding-left: 20px;
            border-radius: 10px;
            margin-bottom: 5px;
            color: #333;
            border-color: #aaa;
        }

        .audio-item:hover {
            background-color: #f0f0f0;
            opacity: 0.8;
        }

        .audio-item:before {
            font-family: 'icomoon';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            transition: color 0.3s ease;
        }

        .audio-item:hover:before {
            color: #007bff;
        }

        .active::before {
            font-family: 'icomoon';
            color: #007bff;
            margin-right: 5px;
        }

        .active {
            background-color: #ddd;
        }

        #audio-controls {
            position: fixed;
            bottom: 10%;
            left: 10%;
            width: 60%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-image: linear-gradient(to right, #ff69b4, #87CEFA);
            padding: 10px;
            box-sizing: border-box;
            z-index: 100;
            border-radius: 100px;
        }

        .control-button {
            margin: 0 5px;
            padding: 0;
            border: none;
            background-color: transparent;
            cursor: pointer;
            outline: none;
            font-size: 1.2em;
        }

        .play-pause i:before {
            content: "\e902";
            font-size: 1.5em;
        }

        .play-pause.playing i:before {
            content: "\e90f";
        }

        .control-button i {
            color: #007bff;
            font-size: 1.2em;
        }

        .control-button:hover i {
            color: #0056b3;
        }

        #time-display {
            display: flex;
            justify-content: space-between;
            margin-left: 10px;
        }

        .active-loop:before {
            content: "\ea2e";
        }

        .active-shuffle:before {
            content: "\ea30";
        }
    </style>
</head>

<body>
    <div id="audio-player">
        <h2>
            <div id="current-song-title">当前歌曲:</div>
        </h2>
        <audio id="audioPlayer" src="" preload="auto"></audio>
        <ul id="audio-list"></ul>
    </div>
    <div id="audio-controls">
        <button onclick="prevTrack()" class="control-button">
            <i class="fas icon-backward-step"></i>
        </button>
        <button onclick="playPause()" class="control-button play-pause">
            <i class="fas icon-play"></i>
        </button>
        <button onclick="nextTrack()" class="control-button">
            <i class="fas icon-forward-step"></i>
        </button>
        <button onclick="togglePlaybackMode()" class="control-button playback-mode">
            <i class="fas icon-retweet"></i>
        </button>
        <div class="progress-barmusic">
            <div class="progress-barmusic-filled " id="progressFilled"></div>
        </div>
        <p id="time-display">
            <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
        </p>
    </div>
</body>

<script>
    let currentTrackIndex = 0;
    const audioPlayer = document.getElementById('audioPlayer');
    const audioListElement = document.getElementById('audio-list');
    let playlist = [];

    let isLooping = false;
    let isShuffling = false;
    let playbackModeIndex = 0;
    const playbackModes = ['normal', 'loop', 'shuffle'];

    function togglePlaybackMode() {
        playbackModeIndex = (playbackModeIndex + 1) % playbackModes.length;
        let mode = playbackModes[playbackModeIndex];

        isLooping = mode === 'loop';
        isShuffling = mode === 'shuffle';

        let iconClass = '';
        let iconName = '';

        if (isLooping) {
            iconClass = 'active-loop';
            iconName = 'icon-retweet';
        } else if (isShuffling) {
            iconClass = 'active-shuffle';
            iconName = 'icon-random';
        }

        let iconElement = document.querySelector('.playback-mode i');
        iconElement.classList.remove('active-loop', 'active-shuffle');
        if (iconName) {
            iconElement.className = `fas ${iconName} ${iconClass}`;
        } else {
            iconElement.className = 'fas icon-retweet';
        }
    }

    function listAudio() {
        fetch('/listaudio')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                const audioList = document.getElementById('audio-list');
                audioList.innerHTML = '';
                playlist = data.musicList;
                data.musicList.forEach((track, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = track.filename;
                    listItem.dataset.index = index;
                    listItem.classList.add('audio-item');
                    listItem.addEventListener('click', () => {
                        currentTrackIndex = index;
                        loadAndPlayTrack(currentTrackIndex);
                    });
                    audioList.appendChild(listItem);
                });

                adjustListHeightBasedOnLines();
            })
            .catch(error => console.error('Error:', error));
    }

    function loadAndPlayTrack(index) {
        if (index < 0 || index >= playlist.length) {
            console.error('无效的索引:', index);
            return;
        }
        const track = playlist[index];
        if (track) {
            audioPlayer.src = track.filepath;

            audioPlayer.play()
                .then(() => {
                    console.log('音频开始播放');
                    document.querySelector('.play-pause').classList.add('playing');
                })
                .catch(error => {
                    console.error('播放请求被中断或失败:', error);
                    audioPlayer.addEventListener('canplay', function playWhenReady() {
                        this.play().then(() => {
                            console.log('音频在缓冲后开始播放');
                            this.removeEventListener('canplay', playWhenReady);
                            document.querySelector('.play-pause').classList.add('playing');
                        }).catch(e => console.error('后续尝试播放失败:', e));
                    });
                });

            setActiveTrack(currentTrackIndex);

            document.getElementById('current-song-title').textContent = `当前歌曲: ${track.filename}`;
        } else {
            console.error('Track not found at the given index.');
        }
    }

    function setActiveTrack(index) {
        const items = audioListElement.children;
        for (let i = 0; i < items.length; i++) {
            items[i].classList.toggle('active', i === index);
        }
    }

    function playPause() {
        if (audioPlayer.paused) {
            audioPlayer.play().catch(error => console.error('Play request was interrupted or failed:', error));
            document.querySelector('.play-pause').classList.add('playing');
        } else {
            audioPlayer.pause();
            document.querySelector('.play-pause').classList.remove('playing');
        }
    }

    function prevTrack() {
        if (currentTrackIndex > 0) {
            currentTrackIndex--;
        } else {
            currentTrackIndex = playlist.length - 1;
        }
        loadAndPlayTrack(currentTrackIndex);
    }

    function nextTrack() {
        if (isLooping && !isShuffling) {
            return;
        } else if (isShuffling) {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * playlist.length);
            } while (newIndex === currentTrackIndex);
            currentTrackIndex = newIndex;
        } else {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
        }
        loadAndPlayTrack(currentTrackIndex);
    }

    audioPlayer.addEventListener('timeupdate', function () {
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const progressBarFilled = document.getElementById('progressFilled');

        currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);

        if (audioPlayer.duration) {
            const progressPercentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBarFilled.style.width = `${progressPercentage}%`;
        }
    });

    function formatTime(seconds) {
        let minutes = Math.floor(seconds / 60);
        let secondsRemainder = Math.round(seconds % 60);
        return `${minutes < 10 ? '0' : ''}${minutes}:${secondsRemainder < 10 ? '0' : ''}${secondsRemainder}`;
    }

    audioPlayer.addEventListener('ended', function () {
        nextTrack();
    });
    audioPlayer.addEventListener('canplaythrough', function () {
        console.log('音频可以持续播放至结束，无需缓冲');
    });

    function adjustListHeightBasedOnLines(lines = 16) {
        const listItem = document.querySelector('.audio-item');
        if (listItem) {
            const lineHeight = listItem.offsetHeight;
            const desiredHeight = lineHeight * lines;
            document.getElementById('audio-list').style.maxHeight = `${desiredHeight}px`;
        } else {
            console.error('No list item found to calculate height.');
        }
    }
    function bytesToSize(bytes) {
        var sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        if (bytes == 0) return '0 B';
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        var size = bytes / Math.pow(1024, i);
        if (sizes[i] !== 'B') {
            size = size.toFixed(2);
        }
        return size + ' ' + sizes[i];
    }
    window.onload = listAudio;
</script>

</html>