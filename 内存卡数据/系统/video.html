<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <link rel="stylesheet" href="../系统/CSS/fontawesome-free-6.5.2-web/css/all.min.css">
    <link rel="stylesheet" href="../系统/css.css" />
    <title>在线影院</title>
</head>
<style>
    .container {
        width: 700px;
        margin: 0px auto 0 350px;
        margin-top: 40px;
        overflow: hidden;
    }

    #videoList li {
        position: relative;
        list-style-type: none;
        background-color: #dfe9f5;
        border-radius: 10px;
        padding: 15px 10px;
        margin-top: 5px;
        margin-bottom: 5px;
        box-sizing: border-box;
    }

    #videoList li a {
        display: inline-block;
        width: 85%;
        padding: 0 0px;
        border-radius: 5px;
        box-sizing: border-box;
    }

    #videoList li:hover {
        background-color: #007bff;
        color: #ffffff;
        cursor: pointer;
    }

    #videoList li:hover .file-size {
        color: inherit;
    }

    .file-size {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        right: 10px;
        color: #666;
        font-size: 0.9em;
    }

    #videoListContainer {
        max-height: 700px;
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
        border-radius: 20px;
        background-color: #f9f9f9;
        padding: 10px;
    }

    #videoListContainer::-webkit-scrollbar {
        display: none;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: rgba(0, 0, 0, 0.4);
        position: relative;
        display: flex;
        margin-top: 10%;
        margin-left: 25%;
        min-width: 320px;
        min-height: 240px;
        padding: 0;
    }

    .close {
        position: relative;
        top: 0;
        right: 0;
        font-size: 30px;
        z-index: 1;
        color: #ff69b4
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    #videoPlayer {
        position: relative;
        justify-content: center;
    }
</style>

<body>
    <nav>
        <ul>
            <li>
                <a class="logo">
                    <img src="../配置/头像.jpg" alt="" />
                    <span class="nav-item">哈哈233的网盘</span>
                </a>
            </li>
            <li>
                <a href="../系统/wifi.html">
                    <i class="fa-sharp fa-solid fa-wifi"></i>
                    <span class="nav-item">网络配置</span>
                </a>
            </li>
            <li>
                <a href="../系统/upload.html">
                    <i class="fa-sharp fa-solid fa-circle-up"></i>
                    <span class="nav-item">文件快传</span>
                </a>
            </li>
            <li>
                <a href="../系统/audio.html">
                    <i class="fa-sharp fa-solid fa-headphones"></i>
                    <span class="nav-item">音乐播放</span>
                </a>
            </li>
            <li>
                <a href="../系统/webgame.html">
                    <i class="fa-sharp fa-solid fa-gamepad"></i>
                    <span class="nav-item">网页游戏</span>
                </a>
            </li>
            <li class="current-page">
                <a href="../系统/video.html">
                    <i class="fa-sharp fa-solid fa-film"></i>
                    <span class="nav-item">私人影院</span>
                </a>
            </li>
            <li>
                <a href="../系统/clipboard.html">
                    <i class="fa-sharp fa-solid fa-clipboard"></i>
                    <span class="nav-item">剪切板</span>
                </a>
            </li>
            <li>
                <a href="../系统/allFile.html">
                    <i class="fa-sharp fa-solid fa-folder"></i>
                    <span class="nav-item">文件总管理</span>
                </a>
            </li>
            <li>
                <a href="/wificonnect">
                    <i class="fa-sharp fa-solid fa-gears"></i>
                    <span class="nav-item">模式转换</span>
                </a>
            </li>
            <li>
                <a href="../系统/set.html">
                    <i class="fa-sharp fa-solid fa-gear"></i>
                    <span class="nav-item">设置</span>
                </a>
            </li>
            <li>
                <a href="">
                    <i class="fa-sharp fa-solid fa-database"></i>
                    <span class="nav-item" id="currentMemory"></span>
                    <span class="nav-item" id="totalMemory"></span>
                </a>
                <div class="progress-bar" id="memory-progress">
                </div>
            </li>
        </ul>
    </nav>
    <div class="container">
        <section id="videoListContainer">
            <ul id="videoList">
            </ul>
        </section>
    </div>
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <video id="videoPlayer" width="800" height="480" controls preload='metadata'></video>
            <span class="close">&times;</span>
        </div>
    </div>
</body>
<script>
    function storage() {
        fetch('/get_video')
            .then(response => response.json())
            .then(data => {
                displayVideoList(data);
                //calStorage(data);
            })
            .then(() => { // 在音乐列表和存储信息处理完毕后，再次发起请求获取存储信息
                return fetch('/get_storage')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        // 这里假设calStorage可以处理多次调用，或者有必要再次调用
                        calStorage(data);
                    })
                    .catch(error => console.error('Error fetching storage info:', error));
            })
            .catch(error => console.error('Error:', error));
    }
    function calStorage(data) {
        const currentMemoryStr = bytesToSize(data.totalstorage);
        const totalMemoryStr = bytesToSize(data.totalstorage - data.storage);

        document.getElementById('currentMemory').innerText = totalMemoryStr;
        document.getElementById('totalMemory').innerText = " / " + currentMemoryStr;

        let percentageUsed = (data.storage / data.totalstorage) * 100;
        percentageUsed = Math.min(percentageUsed, 100);
        const progressBar = document.getElementById('memory-progress');
        progressBar.style.background = `linear-gradient(to right, #007bff 0%, #f3f3 ${percentageUsed}%)`;
    }
    function bytesToSize(bytes) {
        var sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        if (bytes == 0) return '0 B';
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        var size = bytes / Math.pow(1024, i);
        if (sizes[i] !== 'B') {
            size = size.toFixed(2);
        }
        return size + ' ' + sizes[i];
    }
    function displayVideoList(data) {
        const videoList = document.getElementById('videoList');
        videoList.innerHTML = '';

        data.videos.forEach(video => {
            const listItem = document.createElement('li');

            const videoLink = document.createElement('a');
            videoLink.onclick = (e) => {
                e.preventDefault();
                const videoPlayer = document.getElementById('videoPlayer');
                const modal = document.getElementById('videoModal');
                const modalContent = modal.querySelector('.modal-content');

                videoPlayer.src = video.videoPath;
                modal.style.display = 'block';
                modalContent.style.width = `${videoPlayer.offsetWidth}px`;
                modalContent.style.height = `${videoPlayer.offsetHeight}px`;

                const closeButton = modal.querySelector('.close');
                closeButton.onclick = function () {
                    modal.style.display = 'none';
                    videoPlayer.pause();
                    videoPlayer.currentTime = 0;
                    videoPlayer.src = '';
                };

                videoPlayer.play().then(result => {
                    console.log('操作成功，结果是：', result);
                })
                    .catch(error => {
                        console.error('操作失败，原因是：', error);
                    })
                    .finally(() => {
                        console.log('无论成功还是失败，这里的代码都会执行');
                    });
            };

            const videoName = video.videoPath.split('/').pop();
            videoLink.appendChild(document.createTextNode(videoName));
            listItem.appendChild(videoLink);
            const fileSizeText = document.createElement('span');
            fileSizeText.textContent = `(${bytesToSize(video.filesize)})`;
            fileSizeText.className = 'file-size';
            listItem.appendChild(fileSizeText);

            videoList.appendChild(listItem);
        });
    }
    videoPlayer.addEventListener('loadedmetadata', function () {
        console.log('视频元数据已加载，检查是否可以播放');
        if (videoPlayer.readyState >= 2) {
            videoPlayer.play().catch(error => {
                console.error('播放请求被中断或失败:', error);
            });
        }
    });
    window.onload = storage;
</script>

</html>