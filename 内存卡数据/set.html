<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <link rel="stylesheet" href="./CSS/fontawesome-free-6.5.2-web/css/all.min.css">
    <link rel="stylesheet" href="./CSS/css.css" />
    <title>设置</title>
    <style>
        .outer-container {
            margin-top: 20px;
            /* 设定宽度为屏幕的一定百分比，例如占据80%，根据需要调整 */
            width: 500px;
            /* 使其成为右侧固定宽度的块级元素 */
            margin-left: 350px;
            /* 顶部和底部外边距为0，左右自动外边距实现水平居中 */
            padding: 20px;
            /* 内边距，可根据需要调整 */
            background-color: #f0f0f0;
            /* 背景色 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0, 0.1);
            /* 阴影效果 */
            border-radius: 20px;
            /* 边框圆角 */
            /* 当内容超出时，只在y轴上出现滚动条 */
            overflow-y: auto;
        }

        .container {
            width: auto;
            padding: 0;
        }

        .container p {
            line-height: 1;
            margin-bottom: 1rem;
            /* 调整为更大的间距，如需要 */
        }

        .container>* {
            margin-bottom: 1rem;
        }

        .container h2 {
            margin-bottom: 1rem;
            /* 统一底部外边距，保持标题与内容间距一致 */
        }

        #nameText {
            height: 30px;
            /* 您希望的高度，例如30px，可根据需要调整 */
        }

        #Version {
            font-weight: bold;
        }

        /* 为所有提交按钮设定基础样式 */
        .container input[type="file"],
        .container input[type="submit"],
        .container button[type="submit"],
        .container button {
            padding: 0.5rem 0.5rem;
            /* 根据需要调整内边距 */
            background-color: #007bff;
            /* 默认背景色 */
            color: white;
            /* 文本颜色 */
            border: none;
            /* 移除边框 */
            cursor: pointer;
            /* 鼠标指针变为手型 */
            border-radius: 5px;
            /* 边框圆角 */
            font-size: 0.8rem;
            /* 字体大小 */
            transition: background-color 0.3s ease;
            /* 背景颜色过渡效果 */
        }

        /* 鼠标悬停时的样式 */
        .container input[type="file"]:hover,
        .container input[type="submit"]:hover,
        .container button[type="submit"]:hover,
        .container button:hover {
            background-color: #0056b3;
            /* 悬停时的背景色变深 */
        }

        /* 禁用状态的样式（如果需要） */
        .container input[type="file"]:disabled,
        .container input[type="submit"]:disabled,
        .container button[type="submit"]:disabled,
        .container button:disabled {
            background-color: #ccc;
            /* 禁用时的背景色 */
            cursor: not-allowed;
            /* 禁用的光标样式 */
            color: #666;
            /* 文本颜色 */
        }

        .container input[type="file"]:active,
        .container input[type="submit"]:active,
        .container button:active {
            transform: scale(0.98);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .progressBar {
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
        }

        .progressBar::-webkit-progressBar {
            background-color: #eee;
            border-radius: 10px;
        }

        .progressBar::-webkit-progress-value {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .containeother {
            width: 100%;
        }

        .containeother select {
            width: 400px;
            /* 宽度自适应容器 */
            padding: 10px;
            /* 内边距 */
            /* 下边距 */
            border: 1px solid #ddd;
            /* 边框 */
            border-radius: 5px;
            /* 边框圆角 */
            font-size: 14px;
            /* 字体大小 */
            appearance: none;
            /* 移除默认样式 */
            -webkit-appearance: none;
            /* 针对Safari */
            -moz-appearance: none;
            /* 针对Firefox */
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li>
                <a class="logo">
                    <img src="./logo.jpg" alt="" />
                    <span class="nav-item">哈哈233的网盘</span>
                </a>
            </li>
            <li>
                <a href="/wifi.html">
                    <i class="fa-sharp fa-solid fa-wifi"></i>
                    <span class="nav-item">网络配置</span>
                </a>
            </li>
            <li>
                <a href="/upload.html">
                    <i class="fa-sharp fa-solid fa-circle-up"></i>
                    <span class="nav-item">文件快传</span>
                </a>
            </li>
            <li>
                <a href="/audio.html">
                    <i class="fa-sharp fa-solid fa-headphones"></i>
                    <span class="nav-item">音乐播放</span>
                </a>
            </li>
            <li>
                <a href="/webgame.html">
                    <i class="fa-sharp fa-solid fa-gamepad"></i>
                    <span class="nav-item">网页游戏</span>
                </a>
            </li>
            <li>
                <a href="video.html">
                    <i class="fa-sharp fa-solid fa-film"></i>
                    <span class="nav-item">私人影院</span>
                </a>
            </li>
            <li>
                <a href="/clipboard.html">
                    <i class="fa-sharp fa-solid fa-clipboard"></i>
                    <span class="nav-item">剪切板</span>
                </a>
            </li>
            <li>
                <a href="/allFile.html">
                    <i class="fa-sharp fa-solid fa-folder"></i>
                    <span class="nav-item">文件总管理</span>
                </a>
            </li>
            <li>
                <a href="/wificonnect">
                    <i class="fa-sharp fa-solid fa-gears"></i>
                    <span class="nav-item">模式转换</span>
                </a>
            </li>
            <li class="current-page">
                <a href="/set.html">
                    <i class="fa-sharp fa-solid fa-gear"></i>
                    <span class="nav-item">设置</span>
                </a>
            </li>
            <li>
                <a href="">
                    <i class="fa-sharp fa-solid fa-database"></i>
                    <span class="nav-item" id="currentMemory"></span>
                    <span class="nav-item" id="totalMemory"></span>
                </a>
                <div class="progress-bar" id="memory-progress">
                </div>
            </li>
        </ul>
    </nav>
    <div class="outer-container">
        <div class="container">
            <h2>默认主页：</h2>
            <div class="containeother" style="display:flex; justify-content: space-between;">
                <div>
                    <select id="firstWeb" name="firstWeb"></select>
                </div>
                <button onclick="FirstWeb()">提交</button>
            </div>
            <p>
            <form action="/upload" id="upload_form_avatar" enctype="multipart/form-data" method="post">
                <label for="fileUploadAvatar">头像:</label>
                <input type="file" name="file1" id="file1" onchange="uploadFile()">
                <br>
                <progress id="progressBarAvatar" value="0" max="100" style="width:300px;display:none;"></progress>
            </form>
            <p>
            <form action="/upload" id="upload_form_wallpaper" enctype="multipart/form-data" method="post">
                <br><label for="fileUploadWallpaper">壁纸:</label>
                <input type="file" name="file2" id="file2" onchange="uploadFile()">
                <br>
                <progress id="progressBarWallpaper" value="0" max="100" style="width:300px;display:none;"></progress>
            </form>
            </p>
            </p>
            <h2>系统固件更新</h2>
            <p id="Version">当前版本：</p>
            <script src="./JS/jquery-3.6.0.js"></script>
            <form method='POST' action='#' enctype='multipart/form-data' id='OTAupload_form'>
                <input type='file' name='update' id="firmwareFileInput">
                <input type='submit' value='上传固件' id="firmwareSubmitBtn">
            </form>
            <div id='prg'>上传进度: 0%</div>
            <script>
                $('form').submit(function (e) {
                    e.preventDefault();
                    var form = $('#OTAupload_form')[0];
                    var data = new FormData(form);
                    $.ajax({
                        url: '/update',
                        type: 'POST',
                        data: data,
                        contentType: false,
                        processData: false,
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                            xhr.onreadystatechange = function () {
                                if (this.readyState == 4 && this.status == 200) {
                                    window.location.href = "/";
                                }
                            };
                            xhr.upload.addEventListener('progress', function (evt) {
                                if (evt.lengthComputable) {
                                    var per = evt.loaded / evt.total;
                                    $('#prg').html('上传进度: ' + Math.round(per * 100) + '%');
                                }
                            }, false);
                            return xhr;
                        },
                        success: function (d, s) {
                            console.log('成功!')
                            window.location.href = '/';
                        },
                        error: function (a, b, c) {
                            console.log('失败!')
                        }
                    });
                });
                function changeText(value) {
                    // 获取元素  
                    var p = document.getElementById("Version");
                    // 修改文本内容  
                    p.textContent = "当前版本：" + value;
                }
            </script><SMALL>(系统固件上传切记不要关闭电源)</SMALL>
            <p class="text" id="status"></p>
            <p class="text" id="detailsheader"></p>
            <p class="text" id="details"></p>
            <h2>域名前缀：</h2>
            <form action="/nameText">
                <input name="nameText" type="text" id="nameText" value=""> <input type="submit" value="保存（重启后生效）" />
            </form>
            <h2 style="display: inline-block;">网络提供：</h2>
            <span class="text" id="connectwifi" style="display: inline-block;"></span>
            <br />
            <h2 style="display: inline-block;">设备IP：</h2>
            <span class="text" id="ip" style="display: inline-block;"></span>
            <script>
                function nameText() {
                    // 使用fetch API发送GET请求到ESP32服务器  
                    fetch('/get_version')
                        .then(response => response.json()) // 解析返回的JSON数据  
                        .then(data => {
                            // 调用changeText函数并传入版本号  
                            changeText(data.version);
                            document.getElementById('nameText').value = data.text;
                            document.getElementById('firstWeb').value = data.FirstWebis;
                            calStorage(data);
                        })
                        .catch(error => console.error('Error:', error));
                }
                function calStorage(data) {
                    const currentMemoryStr = bytesToSize(data.totalstorage);
                    const totalMemoryStr = bytesToSize(data.totalstorage - data.storage);

                    document.getElementById('currentMemory').innerText = totalMemoryStr;
                    document.getElementById('totalMemory').innerText = " / " + currentMemoryStr;
                    document.getElementById('ip').innerText = data.IPAD;
                    document.getElementById('connectwifi').innerText = data.WIFI;

                    let percentageUsed = (data.storage / data.totalstorage) * 100;
                    percentageUsed = Math.min(percentageUsed, 100);
                    const progressBar = document.getElementById('memory-progress');
                    progressBar.style.background = `linear-gradient(to right, #007bff 0%, #f3f3 ${percentageUsed}%)`;
                }
                function bytesToSize(bytes) {
                    var sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    if (bytes == 0) return '0 B';
                    var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                    var size = bytes / Math.pow(1024, i); // 不预先四舍五入，以便在最后统一处理小数位
                    // 对于非“B”单位，始终保留两位小数
                    if (sizes[i] !== 'B') {
                        size = size.toFixed(2);
                    }
                    return size + ' ' + sizes[i];
                }
                window.onload = nameText;
            </script>
        </div>
    </div>
</body>
<script>
    function _(el) {
        return document.getElementById(el);
    }
    function uploadFile() {
        var file = _("file1").files[0];
        var formdata = new FormData();
        if (file)
            formdata.append("file1", file, 'logo.jpg');
        else {
            var file = _("file2").files[0];
            if (file)
                formdata.append("file2", file, 'background.jpg');
        }
        var ajax = new XMLHttpRequest();
        ajax.upload.addEventListener("progress", progressHandler, false);
        ajax.addEventListener("load", completeHandler, false);
        ajax.addEventListener("error", errorHandler, false);
        ajax.addEventListener("abort", abortHandler, false);
        ajax.open("POST", "/set");
        ajax.send(formdata);
    }
    function progressHandler(event) {
        _("loaded_n_total").innerHTML = "已上传 " + event.loaded + " bytes";
        var percent = (event.loaded / event.total) * 100;
        _("progressBar").value = Math.round(percent);
        _("status").innerHTML = Math.round(percent) + "% 上传中... 请稍等";
        if (percent >= 100) {
            _("status").innerHTML = "请等待, 正在写入文件";
        }
    }
    function completeHandler(event) {
        _("status").innerHTML = "上传完成";
        _("progressBar").value = 0;
        xmlhttp = new XMLHttpRequest();
        xmlhttp.send();
        document.getElementById("status").innerHTML = "上传成功";
        document.getElementById("detailsheader").innerHTML = "<h3>文件列表<h3>";
        document.getElementById("details").innerHTML = xmlhttp.responseText;
    }
    function errorHandler(event) {
        _("status").innerHTML = "上传失败";
    }
    function abortHandler(event) {
        _("status").innerHTML = "上传中断";
    }
    document.addEventListener('DOMContentLoaded', function () {
        // 获取select元素
        var selectElement = document.getElementById('firstWeb');

        // 定义要添加的选项数据
        var optionsData = [
            { value: '1', text: '文件总管理' },
            { value: '2', text: '文件快传' },
            { value: '3', text: '音乐播放' },
            { value: '4', text: '网页游戏' },
            { value: '5', text: '私人影院' },
            { value: '6', text: '剪切板' },
            { value: '7', text: '设置' },
            { value: '8', text: '网络配置' }
        ];

        // 遍历数据并创建、添加选项到select元素中
        optionsData.forEach(function (option) {
            var newOption = document.createElement('option');
            newOption.value = option.value;
            newOption.text = option.text;
            selectElement.appendChild(newOption);
        });
    });
    function FirstWeb() {
        var selectedOption = document.getElementById('firstWeb').value;
        var urltocall = "/FirstWeb?FirstWebis=" + selectedOption;
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                nameText();
                alert("操作成功！");
            }
        };
        xmlhttp.open("GET", urltocall, false);
        xmlhttp.send();
    }
</script>

</html>