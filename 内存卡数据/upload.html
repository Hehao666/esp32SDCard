<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
  <title>文件管理</title>
  <style>
    .container {
      width: 800px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>文件管理</h2>
    <p>
      <button onclick="backRoot()">根目录</button>
      <button onclick="showUploadButtonFancy()">文件上传</button>
      <button onclick="creatfold()">创建文件夹</button>
      <input type="text" name="foldname" value="" id='inputValue' placeholder="请输入要创建的文件夹名称">
    </p>
    <p class="text" id="status"></p>
    <p class="text" id="detailsheader"></p>
    <p class="text" id="details"></p>
  </div>
</body>

<script>
  function deleteButton(filepath) {
    var urltocall = "/deleteUploadFile?deletePath=" + filepath;
    if (confirm("确认删除")) {
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", urltocall, false);
      xmlhttp.send();
      document.getElementById("status").innerHTML = xmlhttp.responseText;
      document.getElementById("details").innerHTML = xmlhttp.responseText;
    }
    window.location.reload();
  }
  function lookthis(filepath) {
    var urltocall = "/lookthis?lookthisPath=" + filepath;
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        window.location.href = "/white.html";
      }
    };
    xmlhttp.open("GET", urltocall, false);
    xmlhttp.send();
  }
  function backRoot() {
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        window.location.href = "/white.html";
      }
    };
    xmlhttp.open("GET", "/backRoot", false);
    xmlhttp.send();
  }
  function creatfold() {
    var textboxValue = document.getElementById("inputValue").value;
    var urltocall = "/uploadaddFold?foldname=" + textboxValue;
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        window.location.href = "/white.html";
        document.getElementById("details").innerHTML = this.responseText;
      } else if (this.status != 200) {
        // 处理服务器错误或其他网络错误  
        document.getElementById("details").innerHTML = this.responseText;
      }
    };
    xmlhttp.open("GET", urltocall, false);
    xmlhttp.send();
  }
  function downloadButton(filepath, filename) {
    var urltocall = "/downloadUploadFile?attname=" + filename + "&downloadPath=" + filepath;
    document.getElementById("status").innerHTML = "";
    window.open(urltocall, '_blank');
  }
  function showUploadButtonFancy() {
    document.getElementById("detailsheader").innerHTML = "<h3>文件上传<h3>"
    document.getElementById("status").innerHTML = "";
    var uploadform =
      "<form action = \"/upload\" id=\"upload_form\" enctype=\"multipart/form-data\" method=\"post\">" +
      "<input type=\"file\" name=\"file1\" id=\"file1\" multiple onchange=\"uploadFile()\"><br>" +
      "<progress id=\"progressBar\" value=\"0\" max=\"100\" style=\"width:300px;\"></progress>" +
      "<h3 id=\"status\"></h3>" +
      "<p id=\"loaded_n_total\"></p>" +
      "</form><SMALL>(文件名不能有空格和奇奇怪怪的符号)</SMALL>";
    document.getElementById("details").innerHTML = uploadform;
  }
  function _(el) {
    return document.getElementById(el);
  }
  function uploadFile() {
    var input = document.getElementById('file1');
    var files = input.files;
    for (let i = 0; i < files.length; i++) {
      var file = files[i];
      var formData = new FormData();
      formData.append('file1', file);

      var ajax = new XMLHttpRequest();
      ajax.upload.addEventListener("progress", function (event) {
        progressHandler(event, i + 1);
      }, false);
      if (i == files.length - 1)
        ajax.addEventListener("load", completeHandler, false);
      ajax.addEventListener("error", errorHandler, false);
      ajax.addEventListener("abort", abortHandler, false);
      ajax.open('POST', '/upload', true);

      ajax.onload = function () {
        if (this.status == 200) {
          console.log('文件上传成功');
        } else {
          console.error('文件上传失败');
        }
      };

      ajax.send(formData);
    }
  }
  function progressHandler(event, index) {
    _("loaded_n_total").innerHTML = index + "/" + document.getElementById('file1').files.length + "已上传 " + event.loaded + " bytes";
    var percent = (event.loaded / event.total) * 100;
    _("progressBar").value = Math.round(percent);
    _("status").innerHTML = Math.round(percent) + "% 上传中... 请稍等";
    if (percent >= 100) {
      _("status").innerHTML = "请等待, 正在写入文件";
    }
  }
  function completeHandler(event) {
    window.location.href = "/white.html";
    _("status").innerHTML = "上传完成";
    _("progressBar").value = 0;
    xmlhttp = new XMLHttpRequest();
    xmlhttp.send();
    document.getElementById("status").innerHTML = "上传成功";
    document.getElementById("detailsheader").innerHTML = "<h3>文件列表<h3>";
    document.getElementById("details").innerHTML = xmlhttp.responseText;
  }
  function errorHandler(event) {
    _("status").innerHTML = "上传失败";
  }
  function abortHandler(event) {
    _("status").innerHTML = "上传中断";
  }
</script>

</html>